function buildPdfTemplate(result) {
  const b = result.batch_summary || {};
  const gaps = (result.common_gaps_top5 || []).slice(0, 5);
  const cases = result.cases || [];
  const msg3 = (result.supervisor_group_message_3lines || []).slice(0, 3);

  const now = new Date();
  const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  const chip = (text) => `
    <span style="display:inline-block;padding:4px 10px;border-radius:999px;background:#EEF2FF;color:#4338CA;font-weight:800;font-size:11px;">
      ${escapeHtml(text)}
    </span>
  `;

  const card = (title, value, sub) => `
    <div class="rounded-3xl border border-slate-100 shadow-sm p-6 bg-white">
      <div class="text-slate-400 text-[10px] font-black uppercase mb-1">${escapeHtml(title)}</div>
      <div class="text-3xl font-black text-slate-900">${escapeHtml(value ?? "unknown")}</div>
      <div class="text-xs text-slate-400 mt-1">${escapeHtml(sub || "")}</div>
    </div>
  `;

  const sectionTitle = (icon, title) => `
    <div class="flex items-center gap-2 mb-4">
      <div class="w-9 h-9 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-500">
        <i class="${icon}"></i>
      </div>
      <div class="text-xl font-black text-slate-900">${escapeHtml(title)}</div>
    </div>
  `;

  const riskList = (title, icon, items, tone) => `
    <div class="rounded-3xl border border-slate-100 bg-white p-6">
      <div class="flex items-center gap-2 mb-3">
        <i class="${icon} ${tone}"></i>
        <div class="font-black text-slate-900">${escapeHtml(title)}</div>
      </div>
      <ul class="space-y-2">
        ${(items || []).slice(0, 8).map(x => `
          <li class="text-sm text-slate-700 flex gap-2">
            <span class="font-black ${tone}">•</span><span>${escapeHtml(x)}</span>
          </li>
        `).join('') || `<li class="text-sm text-slate-400">（無）</li>`}
      </ul>
    </div>
  `;

  const gapCards = gaps.map((g, i) => `
    <div class="rounded-3xl border border-slate-100 bg-white p-6 avoid-break">
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white font-black flex items-center justify-center">${i+1}</div>
          <div>
            <div class="font-black text-slate-900">${escapeHtml(g.gap || "unknown")}</div>
            <div class="text-xs text-slate-500 mt-1">${escapeHtml(g.why_it_loses_deals || "")}</div>
          </div>
        </div>
        ${chip("漏單點")}
      </div>

      <div class="mt-4 grid grid-cols-1 gap-3">
        <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
          <div class="text-[10px] uppercase font-black text-slate-400">修正動作</div>
          <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(g.fix_action || "unknown")}</div>
        </div>
        <div class="rounded-2xl bg-slate-900 p-4">
          <div class="text-[10px] uppercase font-black text-white/60">督導一句話</div>
          <div class="text-sm font-black text-white mt-1">"${escapeHtml(g.coach_script_one_liner || "unknown")}"</div>
        </div>
      </div>
    </div>
  `).join('');

  const caseCards = cases.map((c, idx) => {
    const opp = c.opportunity_grade || {};
    const dm = c.decision_maker || {};
    const disc = c.disc_profile || {};
    const tools = c.validation_tools || {};
    const plan = c.followup_plan || {};
    const barriers = (c.barriers || []).slice(0, 3);

    return `
      <div class="rounded-3xl border border-slate-100 bg-white p-6 avoid-break">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black text-slate-900">${escapeHtml(c.case_id || `Case ${idx+1}`)}</div>
            <div class="text-xs text-slate-500 mt-1">
              類型：${escapeHtml(c.case_type || "unknown")}｜
              訂閱：${escapeHtml(c.subscription_status || "unknown")}｜
              階段：${escapeHtml(c.stage || "unknown")}｜
              商機：${escapeHtml(opp.grade || "unknown")}
            </div>
          </div>
          ${chip(`下一步：${opp.next_best_step || "unknown"}`)}
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">決策者</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(dm.who || "unknown")}（在場：${escapeHtml(dm.present || "unknown")}）</div>
            <div class="text-xs text-slate-500 mt-1">${escapeHtml(dm.risk_note || "")}</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">DISC</div>
            <div class="text-sm font-bold text-slate-800 mt-1">用戶 ${escapeHtml(disc.user_disc || "unknown")}｜照護者 ${escapeHtml(disc.caregiver_disc || "unknown")}</div>
            <div class="text-xs text-slate-500 mt-1">${escapeHtml(disc.inference_basis || "")}</div>
          </div>
        </div>

        <div class="mt-3 rounded-2xl bg-slate-900 p-4">
          <div class="text-[10px] uppercase font-black text-white/60">建議話術</div>
          <div class="text-sm font-black text-white mt-1">"${escapeHtml(disc.script || "unknown")}"</div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-3">
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">REM</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(tools.rem?.status || "unknown")}</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">語音/字詞</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(tools.speech_test?.status || "unknown")}</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">情境驗證</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(tools.situational_validation?.status || "unknown")}</div>
          </div>
        </div>

        <div class="mt-4 rounded-2xl bg-slate-50 border border-slate-100 p-4">
          <div class="text-[10px] uppercase font-black text-slate-400">主要卡關（最多3項）</div>
          <div class="mt-2 space-y-1">
            ${barriers.map(b => `<div class="text-sm text-slate-800">• ${escapeHtml(b.type || "未知")}：${escapeHtml(b.note || "")}</div>`).join('') || `<div class="text-sm text-slate-400">（無）</div>`}
          </div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-3">
          <div class="rounded-2xl bg-white border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">72小時內</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(plan.within_72h?.action || "unknown")}</div>
            <div class="text-xs text-slate-500 mt-1">指標：${escapeHtml(plan.within_72h?.success_metric || "unknown")}</div>
          </div>
          <div class="rounded-2xl bg-white border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">7天內</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(plan.within_7d?.action || "unknown")}</div>
            <div class="text-xs text-slate-500 mt-1">指標：${escapeHtml(plan.within_7d?.success_metric || "unknown")}</div>
          </div>
          <div class="rounded-2xl bg-white border border-slate-100 p-4">
            <div class="text-[10px] uppercase font-black text-slate-400">30天內</div>
            <div class="text-sm font-bold text-slate-800 mt-1">${escapeHtml(plan.within_30d?.action || "unknown")}</div>
            <div class="text-xs text-slate-500 mt-1">指標：${escapeHtml(plan.within_30d?.success_metric || "unknown")}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  return `
    <div class="text-slate-900">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-2xl font-black">督導戰情室｜服務日誌分析報告</div>
          <div class="text-sm text-slate-500 mt-1">產出時間：${escapeHtml(ts)}</div>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-400 font-black uppercase">Clinico / Hearing Care</div>
          <div class="text-xs text-slate-400">（內部使用）</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-3 gap-4">
        ${card("整體強度", b.overall_strength ?? "unknown", "0-100（越高越穩）")}
        ${card("邀約力", b.invite_strength ?? "unknown", "外撥→進店/下一步")}
        ${card("成交力", b.conversion_strength ?? "unknown", "試聽→承諾→收單")}
      </div>

      <div class="mt-6 grid grid-cols-2 gap-4">
        ${riskList("本批主要風險", "fas fa-triangle-exclamation", b.top_risks || [], "text-red-500")}
        ${riskList("本批做得好的地方", "fas fa-bolt", b.top_wins || [], "text-green-600")}
      </div>

      <div class="mt-8">
        ${sectionTitle("fas fa-magnifying-glass-chart", "最常見漏單缺口 Top 5")}
        <div class="grid grid-cols-1 gap-4">
          ${gapCards || `<div class="text-sm text-slate-400">（無）</div>`}
        </div>
      </div>

      <div class="mt-10 page-break">
        ${sectionTitle("fas fa-users-gear", "個案拆解與下一步")}
        <div class="grid grid-cols-1 gap-4">
          ${caseCards || `<div class="text-sm text-slate-400">（無）</div>`}
        </div>
      </div>

      <div class="mt-10 rounded-3xl bg-slate-900 text-white p-6 avoid-break">
        <div class="text-lg font-black">督導三句話（可直接貼群組）</div>
        <div class="mt-3 space-y-2">
          ${msg3.map((m, i) => `<div class="text-sm font-bold">${i+1}. ${escapeHtml(m)}</div>`).join('') || `<div class="text-sm text-white/70">（無）</div>`}
        </div>
      </div>

      <div class="mt-6 text-xs text-slate-400">
        ※ 本報告由系統依據日誌內容自動判讀，未提及資訊以 unknown 呈現；請依實際門市情境補充校正。
      </div>
    </div>
  `;
}

async function downloadReportPdf() {
  if (!lastResult) {
    alert("尚未完成分析，請先執行「一鍵判讀」。");
    return;
  }

  // 1) 準備 PDF 內容
  const pdfContent = document.getElementById("pdfContent");
  pdfContent.innerHTML = buildPdfTemplate(lastResult);

  // 2) 追加 PDF 專用 CSS（避免卡片被切半）
  const style = document.createElement("style");
  style.innerHTML = `
    .avoid-break { page-break-inside: avoid; break-inside: avoid; }
    .page-break { page-break-before: always; break-before: page; }
  `;
  pdfContent.prepend(style);

  // 3) 下載
  const now = new Date();
  const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

  const element = document.getElementById("pdfRoot");

  const opt = {
    margin:       10,                 // mm
    filename:     `服務日誌分析報告_${stamp}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css', 'legacy'] }
  };

  await html2pdf().set(opt).from(element).save();
}
