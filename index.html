<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>督導戰情室｜服務日誌分析與成交優化系統</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .chip { font-size: 11px; font-weight: 900; }
    .avoid-break { break-inside: avoid; page-break-inside: avoid; }
    .page-break { page-break-before: always; break-before: page; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen">

<div class="max-w-7xl mx-auto px-4 py-8">

  <!-- Header -->
  <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-black text-slate-800 flex items-center gap-3">
        <i class="fas fa-headset text-purple-600"></i>
        督導戰情室
      </h1>
      <p class="text-slate-500 font-medium">
        服務日誌自動判讀｜成交風險診斷｜一鍵分析報告 & PDF
      </p>
    </div>

    <div class="flex items-center bg-white shadow-sm border rounded-full px-4 py-2 gap-3 w-full md:w-auto">
      <i class="fas fa-key text-slate-400 text-sm"></i>
      <input id="apiKey" type="password" placeholder="輸入 Gemini API Key"
        class="text-sm outline-none w-full md:w-72">
    </div>
  </header>

  <!-- Input -->
  <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 mb-8">
    <label class="block text-sm font-black text-slate-700 mb-3">
      貼上門市服務 / 外撥工作日誌（不用整理）
    </label>

    <textarea id="logInput"
      class="w-full h-[300px] p-5 bg-slate-50 rounded-2xl focus:ring-2 focus:ring-purple-500 text-sm"
      placeholder="直接貼整天的工作日誌即可，系統會自動判讀…"></textarea>

    <div class="mt-4 flex gap-3 flex-wrap">
      <button onclick="analyzeLog()"
        class="bg-purple-600 hover:bg-purple-700 text-white font-black px-6 py-3 rounded-2xl flex items-center gap-2">
        <i class="fas fa-wand-magic-sparkles"></i> 一鍵分析
      </button>

      <button onclick="generateReport()"
        class="bg-slate-900 hover:bg-slate-800 text-white font-black px-6 py-3 rounded-2xl flex items-center gap-2">
        <i class="fas fa-file-lines"></i> 生成報告
      </button>

      <button onclick="copyReport()"
        class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-black px-6 py-3 rounded-2xl flex items-center gap-2">
        <i class="fas fa-copy"></i> 複製報告
      </button>

      <button onclick="downloadReportPdf()"
        class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-black px-6 py-3 rounded-2xl flex items-center gap-2">
        <i class="fas fa-file-pdf"></i> 下載 PDF
      </button>
    </div>
  </div>

  <!-- Results -->
  <div id="analysisResult" class="space-y-6"></div>

</div>

<!-- PDF Hidden -->
<div id="pdfRoot" class="fixed -left-[99999px] top-0 w-[794px] bg-white">
  <div id="pdfContent" class="p-10"></div>
</div>

<script>
let lastResult = null;
let lastReport = "";

/* ========= Gemini 分析 ========= */
async function analyzeLog() {
  const apiKey = document.getElementById("apiKey").value.trim();
  const log = document.getElementById("logInput").value.trim();
  if (!apiKey || !log) {
    alert("請輸入 API Key 並貼上日誌");
    return;
  }

  const systemPrompt = `
你是資深聽力門市區域督導。
請自動判讀以下工作日誌，輸出 JSON，包含：
- batch_summary（整體/邀約/成交）
- common_gaps_top5
- cases（商機分級、DISC、驗證工具、追蹤）
- supervisor_group_message_3lines
嚴格 JSON，沒有資訊請用 unknown。
`;

  const res = await fetch(
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=" + apiKey,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        systemInstruction: { parts: [{ text: systemPrompt }] },
        contents: [{ parts: [{ text: log }] }],
        generationConfig: { responseMimeType: "application/json", temperature: 0.4 }
      })
    }
  );

  const data = await res.json();
  const raw = data.candidates?.[0]?.content?.parts?.[0]?.text;
  lastResult = JSON.parse(raw);

  document.getElementById("analysisResult").innerHTML = `
    <div class="bg-white rounded-3xl shadow p-6">
      <div class="text-xl font-black text-slate-800 mb-2">分析完成</div>
      <pre class="text-xs bg-slate-100 p-4 rounded-xl overflow-auto">${raw}</pre>
    </div>
  `;
}

/* ========= 文字報告 ========= */
function generateReport() {
  if (!lastResult) { alert("尚未分析"); return; }

  const b = lastResult.batch_summary || {};
  let t = `【督導分析報告】\n\n`;
  t += `整體強度：${b.overall_strength}\n邀約力：${b.invite_strength}\n成交力：${b.conversion_strength}\n\n`;

  (lastResult.common_gaps_top5 || []).forEach((g,i)=>{
    t += `${i+1}. ${g.gap}\n→ 修正：${g.fix_action}\n\n`;
  });

  lastReport = t;
  alert("報告已生成");
}

function copyReport() {
  if (!lastReport) { alert("尚未生成報告"); return; }
  navigator.clipboard.writeText(lastReport);
  alert("已複製");
}

/* ========= PDF ========= */
function downloadReportPdf() {
  if (!lastResult) { alert("尚未分析"); return; }

  const pdf = document.getElementById("pdfContent");
  pdf.innerHTML = `
    <h1 class="text-2xl font-black mb-4">督導戰情室｜分析報告</h1>
    <pre class="text-sm">${lastReport}</pre>
  `;

  html2pdf().from(document.getElementById("pdfRoot")).set({
    margin: 10,
    filename: "服務日誌分析報告.pdf",
    html2canvas: { scale: 2 },
    jsPDF: { unit: "mm", format: "a4" }
  }).save();
}
</script>

</body>
</html>

